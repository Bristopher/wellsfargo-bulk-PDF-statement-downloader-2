<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wells Fargo PDF Downloader</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg:       #191919;
      --surf:     #212121;
      --surf2:    #2a2a2a;
      --bd:       rgba(255,255,255,.07);
      --bd-hi:    rgba(255,255,255,.13);
      --blue:     #2d5a9e;
      --bright:   #4a82d4;
      --glow:     #6ba3f0;
      --soft:     #96c0f5;
      --mist:     #c8d8f0;
      --text:     #bdbdbd;
      --dim:      #666;
      --faint:    #3d3d3d;
      /* syntax */
      --s-bg:     #111;
      --s-text:   #cdd3de;
      --s-cmt:    #6a9a72;
      --s-str:    #b5d99c;
      --s-kw:     #c792ea;
      --s-num:    #f59e6a;
      --s-fn:     #82aaff;
      --s-re:     #f07890;
      --s-ln:     #3a3a3a;
      --s-ln-hi:  #555;
    }

    html { background: var(--bg); }

    body {
      min-height: 100vh;
      background: var(--bg);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: var(--text);
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3.5rem 1rem 5rem;
    }

    /* ── blobs ── */
    .blobs { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0; }
    .blob {
      position: absolute; border-radius: 50%;
      filter: blur(90px); opacity: .08;
      animation: drift var(--d,20s) ease-in-out infinite alternate;
    }
    .blob:nth-child(1){ width:480px;height:480px;top:-100px;left:-80px; background:#2d5a9e;--d:18s; }
    .blob:nth-child(2){ width:360px;height:360px;bottom:-80px;right:-50px;background:#3a78c9;--d:22s;animation-delay:-8s; }
    .blob:nth-child(3){ width:260px;height:260px;top:42%;left:63%;background:#4a82d4;--d:15s;animation-delay:-4s; }
    .blob:nth-child(4){ width:200px;height:200px;top:20%;right:12%;background:#1e4a8a;--d:28s;animation-delay:-12s; }
    @keyframes drift { from{transform:translate(0,0) scale(1)} to{transform:translate(24px,16px) scale(1.06)} }

    /* ── particles ── */
    .particles { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .p {
      position: absolute; border-radius: 50%; background: var(--glow);
      animation: rise var(--dur) ease-in infinite;
      animation-delay: var(--delay); opacity: 0;
    }
    @keyframes rise {
      0%  { transform:translateY(0) scale(0); opacity:0; }
      15% { opacity:.3; } 85% { opacity:.18; }
      100%{ transform:translateY(-110vh) scale(1); opacity:0; }
    }

    /* ── card ── */
    .card {
      position: relative; z-index: 1;
      display: flex; flex-direction: column; align-items: center;
      width: 100%; max-width: 520px;
    }

    .eyebrow {
      font-size:.7rem; letter-spacing:.22em; text-transform:uppercase;
      color:var(--dim); margin-bottom:.6rem;
    }
    h1 {
      font-size:clamp(1.6rem,5vw,2.4rem); font-weight:800;
      color:var(--mist); text-align:center; line-height:1.15;
      text-shadow:0 0 40px rgba(107,163,240,.28); margin-bottom:.4rem;
    }
    .tagline { color:var(--dim); font-size:.88rem; margin-bottom:2.8rem; }

    /* ── bookmarklet button ── */
    .btn-wrap {
      position:relative; display:flex; flex-direction:column;
      align-items:center; gap:1rem; margin-bottom:2.8rem;
    }
    .btn-wrap::before {
      content:''; position:absolute; inset:-20px; border-radius:20px;
      background:radial-gradient(ellipse,rgba(74,130,212,.18) 0%,transparent 70%);
      animation:glow-ring 2.4s ease-in-out infinite; pointer-events:none;
    }
    @keyframes glow-ring { 0%,100%{transform:scale(.9);opacity:.5} 50%{transform:scale(1.1);opacity:1} }

    #bookmarklet {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:1rem 1.9rem; border-radius:8px;
      font-size:.98rem; font-weight:600;
      font-family:'Consolas','Fira Code',monospace;
      color:var(--glow); text-decoration:none; letter-spacing:.05em;
      cursor:grab; user-select:none; position:relative;
      background:#0c0f14;
      border:1.5px solid rgba(74,130,212,.38);
      animation:breathe 2.4s ease-in-out infinite;
      transition:filter .18s ease;
    }
    #bookmarklet::before {
      content:'>';
      color:var(--bright); font-size:1em; flex-shrink:0;
    }
    #bookmarklet::after {
      content:'_';
      color:var(--glow); margin-left:.1rem;
      animation:blink 1.1s step-end infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    #bookmarklet:active { cursor:grabbing; }
    #bookmarklet:hover {
      animation:breathe-fast .85s ease-in-out infinite;
      color:#c2d9f8; filter:brightness(1.05);
    }
    @keyframes breathe {
      0%,100%{
        transform:scale(1);
        border-color:rgba(74,130,212,.38);
        box-shadow:0 0 10px rgba(74,130,212,.18),0 4px 18px rgba(0,0,0,.5);
      }
      50%{
        transform:scale(1.07);
        border-color:rgba(107,163,240,.7);
        box-shadow:0 0 28px rgba(74,130,212,.45),0 4px 18px rgba(0,0,0,.5),0 0 60px rgba(74,130,212,.15);
      }
    }
    @keyframes breathe-fast {
      0%,100%{
        transform:scale(1.03);
        border-color:rgba(107,163,240,.55);
        box-shadow:0 0 20px rgba(74,130,212,.38),0 4px 18px rgba(0,0,0,.5);
      }
      50%{
        transform:scale(1.1);
        border-color:rgba(151,193,255,.85);
        box-shadow:0 0 44px rgba(74,130,212,.6),0 4px 18px rgba(0,0,0,.5),0 0 90px rgba(74,130,212,.2);
      }
    }

    .drag-hint { color:var(--dim); font-size:.82rem; }

    /* ── how-to panel ── */
    .panel {
      width:100%; background:var(--surf); border:1px solid var(--bd);
      border-radius:20px; padding:1.6rem 1.8rem; margin-bottom:1.6rem;
    }
    .panel-title {
      font-size:.68rem; letter-spacing:.2em; text-transform:uppercase;
      color:var(--dim); margin-bottom:1.1rem;
    }
    .steps { display:flex; flex-direction:column; gap:.7rem; }
    .step { display:flex; gap:.8rem; align-items:flex-start; font-size:.88rem; color:#777; line-height:1.5; }
    .step-num {
      flex-shrink:0; width:22px; height:22px; border-radius:50%;
      background:rgba(74,130,212,.14); border:1px solid rgba(74,130,212,.28);
      display:flex; align-items:center; justify-content:center;
      font-size:.7rem; font-weight:700; color:var(--glow); margin-top:.1rem;
    }
    .step em { font-style:normal; color:var(--soft); font-weight:600; }

    .divider {
      width:100%; height:1px; margin:1.6rem 0;
      background:linear-gradient(90deg,transparent,var(--bd-hi),transparent);
    }

    .disclaimer { color:var(--faint); font-size:.72rem; text-align:center; line-height:1.7; max-width:380px; }

    /* ── github link ── */
    .gh-link {
      display:inline-flex; align-items:center; gap:.9rem;
      margin-top:1.8rem; padding:.85rem 1.4rem; border-radius:14px;
      border:1px solid var(--bd); background:var(--surf);
      text-decoration:none; color:var(--dim);
      transition:border-color .25s,background .25s,color .25s,box-shadow .25s,transform .25s;
    }
    .gh-link:hover {
      border-color:rgba(107,163,240,.35); background:rgba(74,130,212,.07);
      color:var(--soft); box-shadow:0 0 24px rgba(74,130,212,.13); transform:translateY(-2px);
    }
    .gh-link:active { transform:translateY(0); }
    .gh-icon { width:26px;height:26px;flex-shrink:0;color:var(--dim);transition:color .25s,transform .35s; }
    .gh-link:hover .gh-icon { color:var(--glow); transform:rotate(8deg) scale(1.1); }
    .gh-text { display:flex;flex-direction:column;gap:.15rem;text-align:left; }
    .gh-label { font-size:.82rem;font-weight:600;letter-spacing:.01em; }
    .gh-sub { font-size:.68rem;color:var(--faint);transition:color .25s; }
    .gh-link:hover .gh-sub { color:var(--dim); }

    /* ── source code section ── */
    .src-section {
      position:relative; z-index:1;
      width:100%; max-width:880px;
      margin-top:2.5rem;
      display:flex; flex-direction:column; align-items:center;
    }

    .src-toggle {
      display:inline-flex; align-items:center; gap:.55rem;
      padding:.65rem 1.3rem; border-radius:10px;
      border:1px solid var(--bd); background:var(--surf);
      color:var(--dim); font-size:.8rem;
      font-family:'Consolas','Fira Code',monospace;
      cursor:pointer; user-select:none;
      transition:border-color .2s,color .2s,background .2s,box-shadow .2s;
    }
    .src-toggle:hover {
      border-color:rgba(107,163,240,.32); color:var(--soft);
      background:var(--surf2); box-shadow:0 0 18px rgba(74,130,212,.1);
    }
    .src-toggle .t-tag { color:var(--bright); }
    .src-toggle .t-chevron { color:var(--bright); transition:transform .35s ease; }
    .src-toggle.open .t-chevron { transform:rotate(180deg); }

    /* collapsible wrapper */
    .src-panel {
      width:100%; max-height:0; overflow:hidden;
      transition:max-height .55s cubic-bezier(.4,0,.2,1);
    }

    /* code block */
    .src-box {
      margin-top:.75rem; border-radius:14px;
      border:1px solid var(--bd); overflow:hidden;
      background:var(--s-bg);
    }
    .src-head {
      display:flex; align-items:center; justify-content:space-between;
      padding:.65rem 1rem; background:#1a1a1a; border-bottom:1px solid var(--bd);
    }
    .src-fname {
      font-family:'Consolas','Fira Code',monospace; font-size:.76rem; color:#777;
      display:flex; align-items:center; gap:.45rem;
    }
    .src-fname b { color:#aaa; font-weight:400; }
    .src-actions { display:flex; gap:.4rem; }
    .src-btn {
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.28rem .65rem; border-radius:6px;
      border:1px solid var(--bd); background:transparent;
      color:var(--dim); font-size:.7rem; cursor:pointer;
      font-family:'Segoe UI',system-ui,sans-serif;
      text-decoration:none;
      transition:border-color .2s,color .2s,background .2s;
    }
    .src-btn:hover { border-color:rgba(107,163,240,.3); color:var(--soft); background:rgba(74,130,212,.07); }

    /* code view */
    .src-code {
      overflow:auto; max-height:62vh; padding:.6rem 0;
    }
    .src-code::-webkit-scrollbar { width:5px; height:5px; }
    .src-code::-webkit-scrollbar-track { background:transparent; }
    .src-code::-webkit-scrollbar-thumb { background:#2e2e2e; border-radius:4px; }
    .src-code::-webkit-scrollbar-thumb:hover { background:#3a3a3a; }

    .src-code table {
      border-collapse:collapse; width:100%;
      font-family:'Consolas','Fira Code','Cascadia Code',monospace;
      font-size:.77rem; line-height:1.7;
    }
    .src-code tr { display:flex; }
    .src-code tr:hover { background:rgba(255,255,255,.022); }
    .src-code .ln {
      flex-shrink:0; width:3.4rem; padding:0 .9rem 0 1rem;
      color:var(--s-ln); text-align:right; user-select:none;
      border-right:1px solid rgba(255,255,255,.04);
    }
    .src-code tr:hover .ln { color:var(--s-ln-hi); }
    .src-code .lc { padding:0 1.4rem; color:var(--s-text); white-space:pre; flex:1; min-width:0; }

    /* token colors */
    .tk-c { color:var(--s-cmt); font-style:italic; }
    .tk-s { color:var(--s-str); }
    .tk-k { color:var(--s-kw); }
    .tk-n { color:var(--s-num); }
    .tk-f { color:var(--s-fn); }
    .tk-r { color:var(--s-re); }
  </style>
</head>
<body>

<div class="blobs">
  <div class="blob"></div><div class="blob"></div>
  <div class="blob"></div><div class="blob"></div>
</div>
<div class="particles" id="particles"></div>

<div class="card">
  <p class="eyebrow">Unofficial Bookmarklet</p>
  <h1>Wells Fargo<br>PDF Downloader</h1>
  <p class="tagline">Grab your statements in one click</p>

  <div class="btn-wrap">
    <a id="bookmarklet" href="#" title="Drag me to your bookmarks bar!">
      Wells Fargo PDF DL
    </a>
    <div class="drag-hint">// drag to bookmarks bar to install</div>
  </div>

  <div class="panel">
    <p class="panel-title">How to use</p>
    <div class="steps">
      <div class="step">
        <span class="step-num">1</span>
        <span>Drag the blue button above to your browser's <em>bookmarks bar</em> (show it with Ctrl+Shift+B)</span>
      </div>
      <div class="step">
        <span class="step-num">2</span>
        <span>Log in to <em>wellsfargo.com</em> and navigate to your Statements page</span>
      </div>
      <div class="step">
        <span class="step-num">3</span>
        <span>Click the <em>Wells Fargo PDF DL</em> bookmark — it will activate and prompt you</span>
      </div>
      <div class="step">
        <span class="step-num">4</span>
        <span>Switch the statement <em>year</em> in the dropdown to trigger the interceptor</span>
      </div>
      <div class="step">
        <span class="step-num">5</span>
        <span>A green <em>Download X Statements</em> button appears — click it and enjoy!</span>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <p class="disclaimer">
    Not affiliated with, endorsed by, or related to Wells Fargo &amp; Company.<br>
    Use only on your own accounts and at your own discretion.
  </p>

  <a class="gh-link" href="https://github.com/Bristopher/wellsfargo-bulk-PDF-statement-downloader-2" target="_blank" rel="noopener">
    <svg class="gh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    </svg>
    <span class="gh-text">
      <span class="gh-label">See source code &amp; main repo</span>
      <span class="gh-sub">Bristopher / wellsfargo-bulk-PDF-statement-downloader-2</span>
    </span>
  </a>
</div>

<!-- ── Source code expand section ── -->
<div class="src-section">
  <button class="src-toggle" id="src-toggle" aria-expanded="false">
    <span class="t-tag">&lt;/&gt;</span>
    <span id="toggle-label">View Source Code</span>
    <span class="t-chevron">▾</span>
  </button>

  <div class="src-panel" id="src-panel">
    <div class="src-box">
      <div class="src-head">
        <div class="src-fname">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <b>original-source.js</b>
        </div>
        <div class="src-actions">
          <button class="src-btn" id="copy-btn">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            Copy
          </button>
          <a class="src-btn" href="https://github.com/Bristopher/wellsfargo-bulk-PDF-statement-downloader-2/blob/main/original-source.js" target="_blank" rel="noopener">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            GitHub
          </a>
        </div>
      </div>
      <div class="src-code" id="src-code-view"></div>
    </div>
  </div>
</div>

<!-- raw source stored as inert data -->
<script id="raw-src" type="text/x-source">javascript:(function(){
    if (window.location.hostname.toLowerCase().indexOf('wellsfargo') === -1) {
        alert('Site is not wells fargo. Go to wellsfargo.com first.');
        return;
    }
    if (!window.oldXHROpen) {
        window.oldXHROpen = window.XMLHttpRequest.prototype.open;
    }
    var interceptor = function(method, url, async) {
        if (url.indexOf('/edocs/documents/statement/list') !== -1) {
            this.addEventListener('load', function() {
                try {
                    var str = this.responseText;
                    var start = str.indexOf('{');
                    var end = str.lastIndexOf('}');
                    if (start === -1 || end === -1) return;
                    str = str.substring(start, end + 1);
                    str = str.replace(/\\"/g, '"');
                    var parsed = JSON.parse(str);
                    var statements = parsed.statementsDisclosuresInfo.statements;

                    var accountName = "Account";
                    try {
                        var activeAccount = parsed.statementsDisclosuresInfo.accountList.find(function(acc) {
                            return acc.selected;
                        });
                        if (activeAccount) {
                            var raw = activeAccount.accountDisplayName.toLowerCase();
                            raw = raw.replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                            accountName = raw.replace(/\s+\.{3}/, '-').replace(/[^a-zA-Z0-9\-\_ ]/g, '');
                        }
                    } catch (err) { console.log(err); }

                    var oldBtn = document.getElementById('wf-dl-btn');
                    if (oldBtn) oldBtn.parentNode.removeChild(oldBtn);

                    var button = document.createElement('button');
                    button.id = 'wf-dl-btn';
                    button.textContent = "Download " + statements.length + " Statements";
                    button.style = "position:fixed; z-index:9999; right:30px; bottom:30px; font-size:20px; background-color:green; color:white; border-radius:5px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.3); cursor:pointer;";
                    document.body.appendChild(button);

                    var cancelButton = document.createElement('button');
                    cancelButton.textContent = "X";
                    cancelButton.style = "position:fixed; z-index:9999; right:10px; bottom:85px; font-size:14px; background-color:red; color:white; border-radius:50%; width:30px; height:30px; border:none; cursor:pointer;";
                    cancelButton.onclick = function() {
                        document.body.removeChild(cancelButton);
                        document.body.removeChild(button);
                    };
                    document.body.appendChild(cancelButton);

                    button.onclick = function() {
                        button.disabled = true;
                        button.style.backgroundColor = 'gray';
                        button.textContent = "Starting Downloads...";
                        var delay = 0;
                        statements.forEach(function(statement, index) {
                            setTimeout(function() {
                                button.textContent = "Downloading " + (index + 1) + " of " + statements.length + "...";
                                var dataUrl = "https://connect.secure.wellsfargo.com" + statement.url;

                                var datePrefix = "0000-00-00";
                                var dateMatch = statement.documentDisplayName.match(/(\d{2})\/(\d{2})\/(\d{2})/);
                                if (dateMatch) {
                                    datePrefix = "20" + dateMatch[3] + "-" + dateMatch[1] + "-" + dateMatch[2];
                                }

                                var safeSuffix = statement.documentDisplayName
                                    .replace(/,/g, "")
                                    .replace(/[:\/\\?*|"<>\(\)]/g, "")
                                    .replace(/\s+/g, "_");

                                /* New Order: Account Name then Date */
                                var finalFilename = "WellsFargo_Statement_" + accountName + "_" + datePrefix + "_" + safeSuffix + ".pdf";

                                fetch(dataUrl)
                                    .then(function(res) { return res.blob(); })
                                    .then(function(blob) {
                                        var url = window.URL.createObjectURL(blob);
                                        var a = document.createElement('a');
                                        a.style.display = 'none';
                                        a.href = url;
                                        a.download = finalFilename;
                                        document.body.appendChild(a);
                                        a.click();
                                        setTimeout(function() {
                                            window.URL.revokeObjectURL(url);
                                            a.parentNode.removeChild(a);
                                        }, 100);
                                    })
                                    .catch(function(err) { console.error(err); });
                            }, delay);
                            delay += 2000;
                        });
                        setTimeout(function() {
                            if (document.body.contains(button)) document.body.removeChild(button);
                            if (document.body.contains(cancelButton)) document.body.removeChild(cancelButton);
                        }, delay + 2000);
                    };
                } catch (e) { console.error("Error:", e); }
            });
        }
        return window.oldXHROpen.apply(this, arguments);
    };
    if (window.XMLHttpRequest.prototype.open !== interceptor) {
        window.XMLHttpRequest.prototype.open = interceptor;
        alert("Statement Downloader Ready. Please refresh the statement list (switch years) to activate.");
    } else {
        alert('Script already active.');
    }
})();
</script>

<script>
  // ── bookmarklet href ──────────────────────────────────────
  const code = `javascript:(function(){if(window.location.hostname.toLowerCase().indexOf('wellsfargo')===-1){alert('Site is not wells fargo. Go to wellsfargo.com first.');return;}if(!window.oldXHROpen){window.oldXHROpen=window.XMLHttpRequest.prototype.open;}var interceptor=function(method,url,async){if(url.indexOf('/edocs/documents/statement/list')!==-1){this.addEventListener('load',function(){try{var str=this.responseText;var start=str.indexOf('{');var end=str.lastIndexOf('}');if(start===-1||end===-1)return;str=str.substring(start,end+1);str=str.replace(/\\"/g,'"');var parsed=JSON.parse(str);var statements=parsed.statementsDisclosuresInfo.statements;var accountName="Account";try{var activeAccount=parsed.statementsDisclosuresInfo.accountList.find(function(acc){return acc.selected;});if(activeAccount){var raw=activeAccount.accountDisplayName.toLowerCase();raw=raw.replace(/\\b\\w/g,function(l){return l.toUpperCase();});accountName=raw.replace(/\\s+\\.{3}/,'-').replace(/[^a-zA-Z0-9\\-\\_ ]/g,'');}}catch(err){console.log(err);}var oldBtn=document.getElementById('wf-dl-btn');if(oldBtn)oldBtn.parentNode.removeChild(oldBtn);var button=document.createElement('button');button.id='wf-dl-btn';button.textContent="Download "+statements.length+" Statements";button.style="position:fixed;z-index:9999;right:30px;bottom:30px;font-size:20px;background-color:green;color:white;border-radius:5px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.3);cursor:pointer;";document.body.appendChild(button);var cancelButton=document.createElement('button');cancelButton.textContent="X";cancelButton.style="position:fixed;z-index:9999;right:10px;bottom:85px;font-size:14px;background-color:red;color:white;border-radius:50%;width:30px;height:30px;border:none;cursor:pointer;";cancelButton.onclick=function(){document.body.removeChild(cancelButton);document.body.removeChild(button);};document.body.appendChild(cancelButton);button.onclick=function(){button.disabled=true;button.style.backgroundColor='gray';button.textContent="Starting Downloads...";var delay=0;statements.forEach(function(statement,index){setTimeout(function(){button.textContent="Downloading "+(index+1)+" of "+statements.length+"...";var dataUrl="https://connect.secure.wellsfargo.com"+statement.url;var datePrefix="0000-00-00";var dateMatch=statement.documentDisplayName.match(/(\\d{2})\\/(\\d{2})\\/(\\d{2})/);if(dateMatch){datePrefix="20"+dateMatch[3]+"-"+dateMatch[1]+"-"+dateMatch[2];}var safeSuffix=statement.documentDisplayName.replace(/,/g,"").replace(/[:\\/\\\\?*|"<>\\(\\)]/g,"").replace(/\\s+/g,"_");var finalFilename="WellsFargo_Statement_"+accountName+"_"+datePrefix+"_"+safeSuffix+".pdf";fetch(dataUrl).then(function(res){return res.blob();}).then(function(blob){var url=window.URL.createObjectURL(blob);var a=document.createElement('a');a.style.display='none';a.href=url;a.download=finalFilename;document.body.appendChild(a);a.click();setTimeout(function(){window.URL.revokeObjectURL(url);a.parentNode.removeChild(a);},100);}).catch(function(err){console.error(err);});},delay);delay+=2000;});setTimeout(function(){if(document.body.contains(button))document.body.removeChild(button);if(document.body.contains(cancelButton))document.body.removeChild(cancelButton);},delay+2000);};}catch(e){console.error("Error:",e);}});}return window.oldXHROpen.apply(this,arguments);};if(window.XMLHttpRequest.prototype.open!==interceptor){window.XMLHttpRequest.prototype.open=interceptor;alert("Statement Downloader Ready. Please refresh the statement list (switch years) to activate.");}else{alert('Script already active.');}})();`;
  document.getElementById('bookmarklet').href = code;

  // ── particles ─────────────────────────────────────────────
  const pWrap = document.getElementById('particles');
  for (let i = 0; i < 18; i++) {
    const p = document.createElement('div');
    p.className = 'p';
    const s = Math.random() * 4 + 2;
    p.style.cssText = `width:${s}px;height:${s}px;left:${Math.random()*100}%;bottom:${-s}px;--dur:${(Math.random()*14+12).toFixed(1)}s;--delay:${(Math.random()*16).toFixed(1)}s;opacity:0`;
    pWrap.appendChild(p);
  }

  // ── syntax highlighter (state machine — handles regex literals) ──
  function highlight(src) {
    const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const KEYWORDS = new Set(['var','let','const','function','return','if','else','for',
      'while','do','try','catch','finally','new','this','typeof','instanceof','in','of',
      'void','delete','throw','break','continue','switch','case','default','true','false',
      'null','undefined','async','await']);
    // after these keywords a '/' starts a regex, not division
    const KW_RE = new Set(['return','typeof','instanceof','void','delete','throw','in','of','case','new']);

    let out = '', i = 0, regexOk = true;
    const n = src.length;

    while (i < n) {
      const ch = src[i];

      // block comment
      if (ch === '/' && src[i+1] === '*') {
        const end = src.indexOf('*/', i + 2);
        const j = end === -1 ? n : end + 2;
        out += `<span class="tk-c">${esc(src.slice(i, j))}</span>`;
        i = j; continue;
      }
      // line comment
      if (ch === '/' && src[i+1] === '/') {
        let j = src.indexOf('\n', i + 2); if (j === -1) j = n;
        out += `<span class="tk-c">${esc(src.slice(i, j))}</span>`;
        i = j; continue;
      }
      // regex literal (only when syntactically valid)
      if (ch === '/' && regexOk) {
        let j = i + 1;
        while (j < n && src[j] !== '/' && src[j] !== '\n') {
          if (src[j] === '\\') j++;
          else if (src[j] === '[') { j++; while (j < n && src[j] !== ']') { if (src[j] === '\\') j++; j++; } }
          j++;
        }
        if (j < n && src[j] === '/') {
          j++;
          while (j < n && /[gimsuy]/.test(src[j])) j++;
          out += `<span class="tk-r">${esc(src.slice(i, j))}</span>`;
          i = j; regexOk = false; continue;
        }
        // not a regex — fall through to output '/' as plain char
      }
      // strings
      if (ch === '"' || ch === "'") {
        let j = i + 1;
        while (j < n && src[j] !== ch && src[j] !== '\n') { if (src[j] === '\\') j++; j++; }
        out += `<span class="tk-s">${esc(src.slice(i, j + 1))}</span>`;
        i = j + 1; regexOk = false; continue;
      }
      // identifiers, keywords, function calls
      if (/[a-zA-Z_$]/.test(ch)) {
        let j = i; while (j < n && /[a-zA-Z0-9_$]/.test(src[j])) j++;
        const word = src.slice(i, j);
        let k = j; while (k < n && (src[k] === ' ' || src[k] === '\t')) k++;
        const isFn = src[k] === '(';
        if (KEYWORDS.has(word)) {
          out += `<span class="tk-k">${esc(word)}</span>`;
          regexOk = KW_RE.has(word);
        } else if (isFn) {
          out += `<span class="tk-f">${esc(word)}</span>`;
          regexOk = true;
        } else {
          out += esc(word);
          regexOk = false;
        }
        i = j; continue;
      }
      // numbers
      if (/\d/.test(ch) || (ch === '.' && /\d/.test(src[i+1]))) {
        let j = i; while (j < n && /[\d.]/.test(src[j])) j++;
        out += `<span class="tk-n">${esc(src.slice(i, j))}</span>`;
        i = j; regexOk = false; continue;
      }
      // track regex context from operators/brackets
      if ('=+-%*&|!<>,;:({[~^?'.includes(ch)) regexOk = true;
      else if (')]}\'"`'.includes(ch)) regexOk = false;
      out += esc(ch);
      i++;
    }
    return out;
  }

  // ── build table with line numbers ─────────────────────────
  function buildCode(src) {
    const lines = highlight(src).split('\n');
    const tbl = document.createElement('table');
    tbl.setAttribute('aria-label', 'Source code');
    lines.forEach((line, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="ln">${i + 1}</td><td class="lc">${line || ' '}</td>`;
      tbl.appendChild(tr);
    });
    return tbl;
  }

  const rawSrc = document.getElementById('raw-src').textContent.trim();
  document.getElementById('src-code-view').appendChild(buildCode(rawSrc));

  // ── toggle expand/collapse ────────────────────────────────
  const toggleBtn = document.getElementById('src-toggle');
  const panel     = document.getElementById('src-panel');
  const label     = document.getElementById('toggle-label');
  let isOpen = false;

  toggleBtn.addEventListener('click', () => {
    isOpen = !isOpen;
    toggleBtn.classList.toggle('open', isOpen);
    toggleBtn.setAttribute('aria-expanded', isOpen);
    label.textContent = isOpen ? 'Hide Source Code' : 'View Source Code';

    if (isOpen) {
      panel.style.maxHeight = panel.scrollHeight + 'px';
      // rAF ensures the browser has started the CSS transition before we scroll,
      // so toggle sits at the top of the viewport while code expands below it
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          toggleBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });
    } else {
      panel.style.maxHeight = '0';
      // gently pull toggle back into view after collapse
      setTimeout(() => toggleBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 300);
    }
  });

  // ── copy button ───────────────────────────────────────────
  document.getElementById('copy-btn').addEventListener('click', async function() {
    try {
      await navigator.clipboard.writeText(rawSrc);
      this.textContent = '✓ Copied!';
      setTimeout(() => {
        this.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy`;
      }, 2000);
    } catch { this.textContent = 'Failed'; }
  });
</script>

</body>
</html>
